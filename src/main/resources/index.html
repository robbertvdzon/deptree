<!DOCTYPE html>
<meta charset="utf-8">
<style>

    .links line {
        stroke: #999;
        stroke-opacity: 0.6;
    }

    .nodes circle {
        stroke: #fff;
        stroke-width: 1.5px;
    }

    svg text {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        cursor: default;
    }
    svg text::selection {
        background: none;
    }

</style>
<svg width="960" height="800"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="jsondata.js"></script>
<script>

    var svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

    var ALL_GROUPS_DIAGRAM = 0;
    var SELECTED_GROUPS_DIAGRAM = 1;
    var GROUP_MODULES_DIAGRAM = 2;
    var SELECTED_MODULE_DIAGRAM = 3;

    var state = ALL_GROUPS_DIAGRAM;
    var selectedGroup = "";
    var selectedModule = "";
    var totalGroups = nodes.groups.length;
    var radius = 150;
    var offset = 400;
    var GROUPS_SMALL_WIDTH = 15;
    var GROUPS_SMALL_HEIGHT = 15;
    var CIRCLE_R = 15;

    defineArrow();
    resetModules();
    positionGroups();
    positionModules();
    positionDepGroupGroups();
    positionDepModuleModule();
    initialPaintGroups();
    initialPaintModules();
    initialPaintDepGroupGroup();
    initialPaintDepModuleModule();

    function defineArrow() {
        svg.append("svg:defs").append("svg:marker")
            .attr("id", "triangle")
            .attr("refX", 6)
            .attr("refY", 6)
            .attr("markerWidth", 30)
            .attr("markerHeight", 30)
            .attr("orient", "auto")
            .append("path")
            .attr("d", "M 0 0 12 6 0 12 2 6")
            .style("fill", "black");
    }


    svg.on("click", function () {
        var coords = d3.mouse(this);

        switch (state) {
            case ALL_GROUPS_DIAGRAM:
                var clickedGroup = findSelectedGroup(coords);
                if (clickedGroup != null) {
                    state = SELECTED_GROUPS_DIAGRAM;
                    selectedGroup = clickedGroup;
                }
                break;
            case SELECTED_GROUPS_DIAGRAM:
                var clickedGroup = findSelectedGroup(coords);

                if (d3.event.ctrlKey) {
                    if (clickedGroup != null ){
                        expandGroup(clickedGroup);
                    }
                }
                else{
                    if (clickedGroup == selectedGroup ) {
                        state = GROUP_MODULES_DIAGRAM;
                    }
                    else if (clickedGroup != null ){
                        selectedGroup = clickedGroup;
                    }
                    else {
                        state = ALL_GROUPS_DIAGRAM;
                    }
                }
                break;
            case GROUP_MODULES_DIAGRAM:
                var clickedModule = findSelectedModule(coords);
                if (clickedModule != null) {
                    state = SELECTED_MODULE_DIAGRAM;
                    selectedModule = clickedModule;
                }
                else{
                    state = SELECTED_GROUPS_DIAGRAM;
                }
                break;
            case SELECTED_MODULE_DIAGRAM:
                var clickedModule = findSelectedModule(coords);
                if (clickedModule != null) {
                    selectedModule = clickedModule;
                }
                else{
                    state = GROUP_MODULES_DIAGRAM;
                }
                break;
        }
        resetModules();
        positionGroups();
        positionModules();
        positionDepGroupGroups();
        positionDepModuleModule();
        repaintGroups();
        repaintModules();
        repaintDepGroupGroup();
        repaintDepModuleModule();
    });

    function findSelectedGroup(coords) {
        for (i = 0; i < nodes.groups.length; i++) {
            var group = nodes.groups[i];
            var mouseX = coords[0];
            var mouseY = coords[1];
            var xFit = (mouseX>group.x) && (mouseX<group.x+group.width)
            var yFit = (mouseY>group.y) && (mouseY<group.y+group.height)
            if (xFit && yFit) {
                return group.name;
            }
        }
        return null;
    }

    function findSelectedModule(coords) {
        for (i = 0; i < nodes.modules.length; i++) {
            var xdiff = coords[0] - nodes.modules[i].x;
            var ydiff = coords[1] - nodes.modules[i].y;
            var distance = Math.sqrt(xdiff * xdiff + ydiff * ydiff);
            if (distance < CIRCLE_R) {
                return nodes.modules[i].name;
            }
        }
        return null;
    }
    function expandGroup(groupname){
        for (i = 0; i < nodes.groups.length; i++) {
            var group = nodes.groups[i];
            if (group.name == groupname){
                group.expanded = !group.expanded;
            }
        }
    }


    function initialPaintGroups() {
        svg
            .selectAll(".group")
            .data(nodes.groups)
            .enter()
            .append("rect")
            .attr("class", "group")
            .attr("x", function(d) { return d.x })
            .attr("y", function(d) { return d.y })
            .attr("width", function(d) { return d.width })
            .attr("height", function(d) { return d.height })
            .attr('stroke-width', 1)
            .attr('stroke', "#000000")
            .style("fill", "#EEEEEE");
        svg
            .selectAll(".groupname")
            .data(nodes.groups)
            .enter()
            .append("text")
            .text(function(d) { return d.name })
            .attr("class", "groupname")
            .attr("x", function(d) { return d.x + GROUPS_SMALL_WIDTH + 10})
            .attr("y", function(d) { return d.y +10})
            .attr("transform", function(d) {
                return "rotate("+d.angle+","+d.x+" ,"+ d.y+")"
            });

    }

    function repaintGroups() {
        svg
            .selectAll(".group")
            .data(nodes.groups)
            .transition()
            .duration(1000)
            .attr('stroke', "#000000" )
            .attr("x", function(d) { return d.x })
            .attr("y", function(d) { return d.y })
            .attr("width", function(d) { return d.width })
            .attr("height", function(d) { return d.height });
        svg
            .selectAll(".groupname")
            .data(nodes.groups)
            .transition()
            .duration(1000)
            .attr("x", function(d) { return d.x + GROUPS_SMALL_WIDTH + 10})
            .attr("y", function(d) { return d.y +10})
            .attr("transform", function(d) {
                return "rotate("+d.angle+","+d.x+" ,"+ d.y+")"
            });
    }

    function initialPaintModules() {
        svg
            .selectAll(".module")
            .data(nodes.modules)
            .enter()
            .append("circle")
            .attr("class", "module")
            .attr("cx", function(d) { return d.x })
            .attr("cy", function(d) { return d.y })
            .attr("r", CIRCLE_R)
            .attr('stroke-width', 1)
            .attr('stroke', "#000000")
            .style("fill", "#EEEEEE");
        svg
            .selectAll(".modulename")
            .data(nodes.modules)
            .enter()
            .append("text")
            .text(function(d) { return d.name })
            .attr("class", "modulename")
            .attr("x", function(d) { return d.x + CIRCLE_R + 10})
            .attr("y", function(d) { return d.y +10})
            .attr("transform", function(d) {
                return "rotate("+d.angle+","+d.x+" ,"+ d.y+")"
            })
        ;

    }

    function repaintModules() {
        svg
            .selectAll(".module")
            .data(nodes.modules)
            .transition()
            .duration(1000)
            .attr("cx", function(d) { return d.x })
            .attr("cy", function(d) { return d.y })
        svg
            .selectAll(".modulename")
            .data(nodes.modules)
            .transition()
            .duration(1000)
            .attr("x", function(d) { return d.x + CIRCLE_R + 10})
            .attr("y", function(d) { return d.y +10})
            .attr("transform", function(d) {
                return "rotate("+d.angle+","+d.x+" ,"+ d.y+")"
            });
    }

    function initialPaintDepGroupGroup() {
        svg
            .selectAll(".depgroupgroup")
            .data(nodes.depGroupGroups)
            .enter()
            .append("line")
            .attr("class", "depgroupgroup")
            .attr("x1", function(d) { return d.x1 })
            .attr("y1", function(d) { return d.y1 })
            .attr("x2", function(d) { return d.x2 })
            .attr("y2", function(d) { return d.y2 })
            .attr("marker-end", "url(#triangle)")
            .attr("stroke-width", 1)
            .attr("stroke", "black");
    }

    function repaintDepGroupGroup() {
        svg
            .selectAll(".depgroupgroup")
            .data(nodes.depGroupGroups)
            .transition()
            .duration(1000)
            .attr("x1", function(d) { return d.x1 })
            .attr("y1", function(d) { return d.y1 })
            .attr("x2", function(d) { return d.x2 })
            .attr("y2", function(d) { return d.y2 });
    }

    function initialPaintDepModuleModule() {
        svg
            .selectAll(".depmodulemodule")
            .data(nodes.depModuleModules)
            .enter()
            .append("line")
            .attr("class", "depmodulemodule")
            .attr("x1", function(d) { return d.x1 })
            .attr("y1", function(d) { return d.y1 })
            .attr("x2", function(d) { return d.x2 })
            .attr("y2", function(d) { return d.y2 })
            .attr("marker-end", "url(#triangle)")
            .attr("stroke-width", 1)
            .attr("stroke", "black");
    }

    function repaintDepModuleModule() {
        svg
            .selectAll(".depmodulemodule")
            .data(nodes.depModuleModules)
            .transition()
            .duration(1000)
            .attr("x1", function(d) { return d.x1 })
            .attr("y1", function(d) { return d.y1 })
            .attr("x2", function(d) { return d.x2 })
            .attr("y2", function(d) { return d.y2 });
    }

    function createGroupArray(){
        var allGroups = {};
        for (i = 0; i < nodes.groups.length; i++) {
            var group = nodes.groups[i];
            allGroups[group.name] = group;
        }
        return allGroups;
    }

    function createModuleArray(){
        var allModules = {};
        for (i = 0; i < nodes.modules.length; i++) {
            var module = nodes.modules[i];
            allModules[module.name] = module;
        }
        return allModules;
    }

    function placeXYOnEdges(dep){
        var xOffset = dep.x1 - dep.x2;
        var yOffset = dep.y1 - dep.y2;
        var leng = Math.sqrt(xOffset * xOffset + yOffset * yOffset);
        if (leng==0) return;
        var percOff = 20 / leng;
        var newX1 = dep.x1 - xOffset * percOff;
        var newY1 = dep.y1 - yOffset * percOff;
        var newX2 = dep.x2 + xOffset * percOff;
        var newY2 = dep.y2 + yOffset * percOff;
        dep.x1 = newX1;
        dep.y1 = newY1;
        dep.x2 = newX2;
        dep.y2 = newY2;
    }

    function positionDepGroupGroups(){
        var groupCache = createGroupArray();
        switch (state) {
            case ALL_GROUPS_DIAGRAM:
                for (i = 0; i < nodes.depGroupGroups.length; i++) {
                    var dep = nodes.depGroupGroups[i];
                    var groupFrom = groupCache[dep.from];
                    var groupTo = groupCache[dep.to];
                    dep.x1 = groupFrom.x+groupFrom.width/2;
                    dep.y1 = groupFrom.y+groupFrom.height/2;
                    dep.x2 = groupTo.x+groupTo.width/2;
                    dep.y2 = groupTo.y+groupTo.height/2;
                    placeXYOnEdges(dep);
                }
                break;
            case SELECTED_GROUPS_DIAGRAM:
                for (i = 0; i < nodes.depGroupGroups.length; i++) {
                    var dep = nodes.depGroupGroups[i];
                    var groupFrom = groupCache[dep.from];
                    var groupTo = groupCache[dep.to];
                    if (
                        groupFrom.isVisible
                        && groupTo.isVisible
                        && (groupFrom.name == selectedGroup || groupTo.name == selectedGroup)
                    ) {
                        dep.x1 = groupFrom.x+groupFrom.width/2;
                        dep.y1 = groupFrom.y+groupFrom.height/2;
                        dep.x2 = groupTo.x+groupTo.width/2;
                        dep.y2 = groupTo.y+groupTo.height/2;
                        placeXYOnEdges(dep);
                    }
                    else{
                        dep.x1 = -1;
                        dep.y1 = -1;
                        dep.x2 = -1;
                        dep.y2 = -1;
                    }
                }
                break;
            case GROUP_MODULES_DIAGRAM:
            case SELECTED_MODULE_DIAGRAM:
                for (i = 0; i < nodes.depGroupGroups.length; i++) {
                    var dep = nodes.depGroupGroups[i];
                    dep.x1 = -1;
                    dep.y1 = -1;
                    dep.x2 = -1;
                    dep.y2 = -1;
                }
                break;
        }
    }

    function positionDepModuleModule(){
        var moduleCache = createModuleArray();
        switch (state) {
            case ALL_GROUPS_DIAGRAM:
                for (i = 0; i < nodes.depModuleModules.length; i++) {
                    var dep = nodes.depModuleModules[i];
                    dep.x1 = -1;
                    dep.y1 = -1;
                    dep.x2 = -1;
                    dep.y2 = -1;
                }
                break;
            case SELECTED_GROUPS_DIAGRAM:
                for (i = 0; i < nodes.depModuleModules.length; i++) {
                    var dep = nodes.depModuleModules[i];
                    dep.x1 = -1;
                    dep.y1 = -1;
                    dep.x2 = -1;
                    dep.y2 = -1;
                }
                break;
            case GROUP_MODULES_DIAGRAM:
                for (i = 0; i < nodes.depModuleModules.length; i++) {
                    var dep = nodes.depModuleModules[i];
                    var moduleFrom = moduleCache[dep.from];
                    var moduleTo = moduleCache[dep.to];
                    if (
                        moduleFrom.isVisible
                        && moduleTo.isVisible
                    ) {
                        dep.x1 = moduleFrom.x;
                        dep.y1 = moduleFrom.y;
                        dep.x2 = moduleTo.x;
                        dep.y2 = moduleTo.y;
                        placeXYOnEdges(dep);
                    }
                    else{
                        dep.x1 = -1;
                        dep.y1 = -1;
                        dep.x2 = -1;
                        dep.y2 = -1;
                    }
                    placeXYOnEdges(dep);
                }
                break;
            case SELECTED_MODULE_DIAGRAM:
                for (i = 0; i < nodes.depModuleModules.length; i++) {
                    var dep = nodes.depModuleModules[i];
                    var moduleFrom = moduleCache[dep.from];
                    var moduleTo = moduleCache[dep.to];
                    if (
                        moduleFrom.isVisible
                        && moduleTo.isVisible
                        && (moduleFrom.name == selectedModule || moduleTo.name == selectedModule)
                    ) {
                        dep.x1 = moduleFrom.x;
                        dep.y1 = moduleFrom.y;
                        dep.x2 = moduleTo.x;
                        dep.y2 = moduleTo.y;
                        placeXYOnEdges(dep);
                    }
                    else{
                        dep.x1 = -1;
                        dep.y1 = -1;
                        dep.x2 = -1;
                        dep.y2 = -1;
                    }
                }
                break;
        }
    }

    function expandWithModules(group) {
        var modulesCount = 0;
        for (j = 0; j < nodes.modules.length; j++) {
            var module = nodes.modules[j];
            if (module.group == group.name) {
                modulesCount++;
                module.isVisible = true;
                module.x = group.x + 10 + CIRCLE_R + (modulesCount - 1) * (CIRCLE_R * 2 + 2);
                module.y = group.y + 30;
            }
        }
        group.width = GROUPS_SMALL_WIDTH + 10 + CIRCLE_R + (modulesCount - 1) * (CIRCLE_R * 2 + 2) + CIRCLE_R;
        group.height = GROUPS_SMALL_HEIGHT + 40;
    }



    function positionGroups() {
        switch (state) {
            case ALL_GROUPS_DIAGRAM:
                for (i = 0; i < nodes.groups.length; i++) {
                    var angle = (360 / totalGroups) * i;
                    var x = offset + radius * Math.cos(angle * Math.PI / 180);
                    var y = offset + radius * Math.sin(angle * Math.PI / 180);
                    nodes.groups[i].x = x;
                    nodes.groups[i].y = y;
                    nodes.groups[i].width = GROUPS_SMALL_WIDTH;
                    nodes.groups[i].height = GROUPS_SMALL_HEIGHT;
                    nodes.groups[i].angle = angle
                    nodes.groups[i].isVisible = true;
                }
                break;
            case SELECTED_GROUPS_DIAGRAM:
                var groupDepsTo = []
                var groupDepsFrom = []
                for (i = 0; i < nodes.depGroupGroups.length; i++) {
                    var depGroupGroup = nodes.depGroupGroups[i];
                    if (depGroupGroup.from == selectedGroup){
                        if (groupDepsTo.indexOf(depGroupGroup.to)==-1) {
                            groupDepsTo.push(depGroupGroup.to);
                        }
                    }
                }
                for (i = 0; i < nodes.depGroupGroups.length; i++) {
                    var depGroupGroup = nodes.depGroupGroups[i];
                    if (depGroupGroup.to == selectedGroup){
                        if ((groupDepsFrom.indexOf(depGroupGroup.to)==-1) && groupDepsTo.indexOf(depGroupGroup.to)==-1) {
                            groupDepsFrom.push(depGroupGroup.from);
                        }
                    }
                }
                var depFromIndex = 0;
                var depToIndex = 0;
                var nextX = 50;

                for (i = 0; i < nodes.groups.length; i++) {
                    var group = nodes.groups[i];
                    var groupName = nodes.groups[i].name;
                    if (groupDepsFrom.indexOf(groupName)!=-1){
                        group.x = nextX;
                        group.y = 100;
                        nodes.groups[i].angle = -45;
                        group.width = GROUPS_SMALL_WIDTH;
                        group.height = GROUPS_SMALL_HEIGHT;
                        group.isVisible = true;
                        if (group.expanded){
                            expandWithModules(group);
                        }
                        depFromIndex++;
                        nextX = group.x+group.width+10;
                    }
                    else if (groupDepsTo.indexOf(groupName)!=-1){
                        nodes.groups[i].x = 50+depToIndex*50;
                        nodes.groups[i].y = 300;
                        nodes.groups[i].angle = 45;
                        nodes.groups[i].width = GROUPS_SMALL_WIDTH;
                        nodes.groups[i].height = GROUPS_SMALL_HEIGHT;
                        nodes.groups[i].isVisible = true;
                        if (group.expanded){
                            expandWithModules(group);
                        }
                        depToIndex++;
                    }
                    else if (groupName == selectedGroup){
                        nodes.groups[i].x = 200;
                        nodes.groups[i].y = 200;
                        nodes.groups[i].angle = 0;
                        nodes.groups[i].width = GROUPS_SMALL_WIDTH;
                        nodes.groups[i].height = GROUPS_SMALL_HEIGHT;
                        nodes.groups[i].isVisible = true;
                        if (group.expanded){
                            expandWithModules(group);
                        }
                    }
                    else{
                        nodes.groups[i].width = 0;
                        nodes.groups[i].height = 0;
                        nodes.groups[i].x = 0;
                        nodes.groups[i].y = -20;
                        nodes.groups[i].isVisible = false;
                    }
                }
                break;
            case GROUP_MODULES_DIAGRAM:
            case SELECTED_MODULE_DIAGRAM:
                for (i = 0; i < nodes.groups.length; i++) {
                    var groupName = nodes.groups[i].name;
                    if (groupName == selectedGroup){
                        nodes.groups[i].x = 2;
                        nodes.groups[i].y = 2;
                        nodes.groups[i].width = width-4;
                        nodes.groups[i].height = height-4;
                    }
                    else{
                        nodes.groups[i].width = 0;
                        nodes.groups[i].height = 0;
                        nodes.groups[i].x = 0;
                        nodes.groups[i].y = -20;
                    }
                }
                break;
            default:
                for (i = 0; i < nodes.groups.length; i++) {
                    nodes.groups[i].x = CIRCLE_R*-1;
                    nodes.groups[i].y = CIRCLE_R*-1;
                }
                break;
        }
    }

    function resetModules() {
        for (i = 0; i < nodes.modules.length; i++) {
            nodes.modules[i].x = CIRCLE_R*-1;
            nodes.modules[i].y = CIRCLE_R*-1;
            nodes.modules[i].isVisible = false;
        }
    }

    function positionModules() {
        var groupModules = [];
        for (i = 0; i < nodes.modules.length; i++) {
            var module = nodes.modules[i];
            if (module.group == selectedGroup) {
                groupModules.push(module);
            }
        }

        var totalModules = groupModules.length;


        // set only the selected modules
        switch (state) {
            case ALL_GROUPS_DIAGRAM:
                break;
            case SELECTED_GROUPS_DIAGRAM:
                break;
            case GROUP_MODULES_DIAGRAM:
                for (i = 0; i < groupModules.length; i++) {
                    var angle = (360 / totalModules) * i;
                    var x = offset + radius * Math.cos(angle * Math.PI / 180);
                    var y = offset + radius * Math.sin(angle * Math.PI / 180);
                    groupModules[i].x = x;
                    groupModules[i].y = y;
                    groupModules[i].angle = angle;
                    groupModules[i].isVisible = true;
                }
                break;
            case SELECTED_MODULE_DIAGRAM:
                var modulesDepsTo = [];
                var modulesDepsFrom = [];
                for (i = 0; i < nodes.depModuleModules.length; i++) {
                    var depModuleModule = nodes.depModuleModules[i];
                    if (depModuleModule.from == selectedModule){
                        if (modulesDepsTo.indexOf(depModuleModule.to)==-1) {
                            modulesDepsTo.push(depModuleModule.to);
                        }
                    }
                }
                for (i = 0; i < nodes.depModuleModules.length; i++) {
                    var depModuleModule = nodes.depModuleModules[i];
                    if (depModuleModule.to == selectedModule){
                        if ((modulesDepsFrom.indexOf(depModuleModule.to)==-1) && modulesDepsFrom.indexOf(depModuleModule.to)==-1) {
                            modulesDepsFrom.push(depModuleModule.from);
                        }
                    }
                }
                var depFromIndex = 0;
                var depToIndex = 0;

                for (i = 0; i < groupModules.length; i++) {
                    var moduleName = groupModules[i].name;
                    if (modulesDepsFrom.indexOf(moduleName)!=-1){
                        groupModules[i].x = 50+depFromIndex*50;
                        groupModules[i].y = 200;
                        groupModules[i].angle = -45;
                        groupModules[i].isVisible = true;
                        depFromIndex++;
                    }
                    else if (modulesDepsTo.indexOf(moduleName)!=-1){
                        groupModules[i].x = 50+depToIndex*50;
                        groupModules[i].y = 400;
                        groupModules[i].angle = 45;
                        groupModules[i].isVisible = true;
                        depToIndex++;
                    }
                    else if (moduleName == selectedModule){
                        groupModules[i].x = 200;
                        groupModules[i].y = 300;
                        groupModules[i].angle = 0;
                        groupModules[i].isVisible = true;
                    }
                    else{
                        groupModules[i].width = 0;
                        groupModules[i].height = 0;
                        groupModules[i].x = 0;
                        groupModules[i].y = -20;
                    }
                }
                break;

            default:
                break;
        }
    }


</script>