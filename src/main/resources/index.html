<!DOCTYPE html>
<meta charset="utf-8">
<style>

    .links line {
        stroke: #999;
        stroke-opacity: 0.6;
    }

    .nodes circle {
        stroke: #fff;
        stroke-width: 1.5px;
    }

    svg text {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        cursor: default;
    }
    svg text::selection {
        background: none;
    }

</style>
<svg width="960" height="800"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="jsondata.js"></script>
<script src="groups.js"></script>
<script src="modules.js"></script>
<script src="depbase.js"></script>
<script src="depgroupgroup.js"></script>
<script src="depgroupmodule.js"></script>
<script src="depmodulegroup.js"></script>
<script src="depmodulemodule.js"></script>
<script>

    var svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

    var ALL_GROUPS_DIAGRAM = 0;
    var SELECTED_GROUPS_DIAGRAM = 1;
    var GROUP_MODULES_DIAGRAM = 2;
    var SELECTED_MODULE_DIAGRAM = 3;

    var state = ALL_GROUPS_DIAGRAM;
    var selectedGroup = "";
    var selectedModule = "";
    var totalGroups = nodes.groups.length;
    var RADIUS_GROUPS = 250;
    var RADIUS_GROUP_MODULE = 150;
    var offset = 400;
    var GROUPS_SMALL_WIDTH = 15;
    var GROUPS_SMALL_HEIGHT = 15;
    var CIRCLE_R = 10;

    defineArrow();
    resetModules();
    positionGroups();
    positionModules();
    positionDepGroupGroups();
    positionDepModuleModule();
    positionDepGroupModule();
    positionDepModuleGroup();
    initialPaintGroups();
    initialPaintModules();
    initialPaintDepGroupGroup();
    initialPaintDepModuleModule();
    initialPaintDepGroupModule();
    initialPaintDepModuleGroup();

    function defineArrow() {
        svg.append("svg:defs").append("svg:marker")
            .attr("id", "triangle")
            .attr("refX", 12)
            .attr("refY", 6)
            .attr("markerWidth", 30)
            .attr("markerHeight", 30)
            .attr("orient", "auto")
            .append("path")
            .attr("d", "M 0 0 12 6 0 12 2 6")
            .style("fill", "black");
    }


    svg.on("click", function () {
        var coords = d3.mouse(this);

        switch (state) {
            case ALL_GROUPS_DIAGRAM:
                var clickedGroup = findSelectedGroup(coords);
                if (clickedGroup != null) {
                    state = SELECTED_GROUPS_DIAGRAM;
                    selectedGroup = clickedGroup;
                }
                break;
            case SELECTED_GROUPS_DIAGRAM:
                var clickedGroup = findSelectedGroup(coords);

                if (d3.event.ctrlKey) {
                    if (clickedGroup != null ){
                        expandGroup(clickedGroup);
                    }
                }
                else{
                    if (clickedGroup == selectedGroup ) {
                        state = GROUP_MODULES_DIAGRAM;
                    }
                    else if (clickedGroup != null ){
                        selectedGroup = clickedGroup;
                    }
                    else {
                        state = ALL_GROUPS_DIAGRAM;
                    }
                }
                break;
            case GROUP_MODULES_DIAGRAM:
                var clickedModule = findSelectedModule(coords);
                if (clickedModule != null) {
                    state = SELECTED_MODULE_DIAGRAM;
                    selectedModule = clickedModule;
                }
                else{
                    state = SELECTED_GROUPS_DIAGRAM;
                }
                break;
            case SELECTED_MODULE_DIAGRAM:
                var clickedModule = findSelectedModule(coords);
                if (clickedModule != null) {
                    selectedModule = clickedModule;
                }
                else{
                    state = GROUP_MODULES_DIAGRAM;
                }
                break;
        }
        resetModules();
        positionGroups();
        positionModules();
        positionDepGroupGroups();
        positionDepModuleModule();
        positionDepGroupModule();
        positionDepModuleGroup();
        repaintGroups();
        repaintModules();
        repaintDepGroupGroup();
        repaintDepModuleModule();
        repaintDepGroupModule();
        repaintDepModuleGroup();
    });

    function findSelectedGroup(coords) {
        for (i = 0; i < nodes.groups.length; i++) {
            var group = nodes.groups[i];
            var mouseX = coords[0];
            var mouseY = coords[1];
            var xFit = (mouseX>group.x) && (mouseX<group.x+group.width)
            var yFit = (mouseY>group.y) && (mouseY<group.y+group.height)
            if (xFit && yFit) {
                return group.name;
            }
        }
        return null;
    }

    function findSelectedModule(coords) {
        for (i = 0; i < nodes.modules.length; i++) {
            var xdiff = coords[0] - nodes.modules[i].x;
            var ydiff = coords[1] - nodes.modules[i].y;
            var distance = Math.sqrt(xdiff * xdiff + ydiff * ydiff);
            if (distance < CIRCLE_R) {
                return nodes.modules[i].name;
            }
        }
        return null;
    }
    function expandGroup(groupname){
        for (i = 0; i < nodes.groups.length; i++) {
            var group = nodes.groups[i];
            if (group.name == groupname){
                group.expanded = !group.expanded;
            }
        }
    }
    function createGroupArray(){
        var allGroups = {};
        for (i = 0; i < nodes.groups.length; i++) {
            var group = nodes.groups[i];
            allGroups[group.name] = group;
        }
        return allGroups;
    }

    function createModuleArray(){
        var allModules = {};
        for (i = 0; i < nodes.modules.length; i++) {
            var module = nodes.modules[i];
            allModules[module.name] = module;
        }
        return allModules;
    }

    function getEdgeOfModule(module, otherEdge){
        var xOffset = module.x - otherEdge.x;
        var yOffset = module.y - otherEdge.y;
        var leng = Math.sqrt(xOffset * xOffset + yOffset * yOffset);
        if (leng==0) return;
        var percOff = CIRCLE_R / leng;
        var point = {};
        point.x = module.x - xOffset * percOff;
        point.y = module.y - yOffset * percOff;
        return point;
    }

    /*
        function placeXYOnEdges(dep){
            var xOffset = dep.x1 - dep.x2;
            var yOffset = dep.y1 - dep.y2;
            var leng = Math.sqrt(xOffset * xOffset + yOffset * yOffset);
            if (leng==0) return;
            var percOff = 20 / leng;
            var newX1 = dep.x1 - xOffset * percOff;
            var newY1 = dep.y1 - yOffset * percOff;
            var newX2 = dep.x2 + xOffset * percOff;
            var newY2 = dep.y2 + yOffset * percOff;
            dep.x1 = newX1;
            dep.y1 = newY1;
            dep.x2 = newX2;
            dep.y2 = newY2;
        }
        */

</script>