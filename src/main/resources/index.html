<!DOCTYPE html>
<meta charset="utf-8">
<style>

    .links line {
        stroke: #999;
        stroke-opacity: 0.6;
    }

    .nodes circle {
        stroke: #fff;
        stroke-width: 1.5px;
    }

    svg text {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        cursor: default;
    }
    svg text::selection {
        background: none;
    }

</style>
<svg width="960" height="600"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="jsondata.js"></script>
<script>

    var svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

    var ALL_GROUPS_DIAGRAM = 0;
    var SELECTED_GROUPS_DIAGRAM = 1;
    var GROUP_MODULES_DIAGRAM = 2;

    var state = ALL_GROUPS_DIAGRAM;
    var selectedGroup = "";
    var totalGroups = nodes.groups.length;
    var radius = 250;
    var offset = 300;
    var GROUPS_SMALL_WIDTH = 15;
    var GROUPS_SMALL_HEIGHT = 15;
    var CIRCLE_R = 15;

    positionGroups();
    positionModules();
    initialPaintGroups();
    initialPaintModules();

    svg.on("dblclick", function () {
        var coords = d3.mouse(this);

        switch (state) {
            case ALL_GROUPS_DIAGRAM:
                var clickedGroup = findSelectedGroup(coords);
                if (clickedGroup != null) {
                    state = SELECTED_GROUPS_DIAGRAM;
                    selectedGroup = clickedGroup;
                }
                break;
            case SELECTED_GROUPS_DIAGRAM:
                var clickedGroup = findSelectedGroup(coords);
                if (clickedGroup == selectedGroup ) {
                    state = GROUP_MODULES_DIAGRAM;
                }
                else if (clickedGroup != null ){
                    selectedGroup = clickedGroup;
                }
                else {
                    state = ALL_GROUPS_DIAGRAM;
                }
                break;
            case GROUP_MODULES_DIAGRAM:
                state = SELECTED_GROUPS_DIAGRAM;
                break;
        }
        positionGroups();
        positionModules();
        repaintGroups();
        repaintModules();
    });

    function findSelectedGroup(coords) {
        for (i = 0; i < nodes.groups.length; i++) {
            var group = nodes.groups[i];
            var mouseX = coords[0];
            var mouseY = coords[1];
            var xFit = (mouseX>group.x) && (mouseX<group.x+group.width)
            var yFit = (mouseY>group.y) && (mouseY<group.y+group.height)
            if (xFit && yFit) {
                return group.name;
            }
        }
        return null;
    }

    function findSelectedModule(coords) {
        for (i = 0; i < nodes.modules.length; i++) {
            var xdiff = coords[0] - nodes.modules[i].x;
            var ydiff = coords[1] - nodes.modules[i].y;
            var distance = Math.sqrt(xdiff * xdiff + ydiff * ydiff);
            if (distance < CIRCLE_R) {
                return nodes.modules[i].name;
            }
        }
        return null;
    }

    function initialPaintGroups() {
        svg
            .selectAll(".group")
            .data(nodes.groups)
            .enter()
            .append("rect")
            .attr("class", "group")
            .attr("x", function(d) { return d.x })
            .attr("y", function(d) { return d.y })
            .attr("width", function(d) { return d.width })
            .attr("height", function(d) { return d.height })
            .attr('stroke-width', 1)
            .attr('stroke', "#000000")
            .style("fill", "#EEEEEE");
        svg
            .selectAll(".groupname")
            .data(nodes.groups)
            .enter()
            .append("text")
            .text(function(d) { return d.name })
            .attr("class", "groupname")
            .attr("x", function(d) { return d.x + GROUPS_SMALL_WIDTH + 10})
            .attr("y", function(d) { return d.y +10});
    }

    function repaintGroups() {
        svg
            .selectAll(".group")
            .data(nodes.groups)
            .transition()
            .duration(1000)
            .attr("x", function(d) { return d.x })
            .attr("y", function(d) { return d.y })
            .attr("width", function(d) { return d.width })
            .attr("height", function(d) { return d.height });
        svg
            .selectAll(".groupname")
            .data(nodes.groups)
            .transition()
            .duration(1000)
            .attr("x", function(d) { return d.x + GROUPS_SMALL_WIDTH + 10})
            .attr("y", function(d) { return d.y +10});
    }

    function initialPaintModules() {
        svg
            .selectAll(".module")
            .data(nodes.modules)
            .enter()
            .append("circle")
            .attr("class", "module")
            .attr("cx", function(d) { return d.x })
            .attr("cy", function(d) { return d.y })
            .attr("r", CIRCLE_R)
            .attr('stroke-width', 1)
            .attr('stroke', "#000000")
            .style("fill", "#EEEEEE");
        svg
            .selectAll(".modulename")
            .data(nodes.modules)
            .enter()
            .append("text")
            .text(function(d) { return d.name })
            .attr("class", "modulename")
            .attr("x", function(d) { return d.x + CIRCLE_R + 10})
            .attr("y", function(d) { return d.y +10});
    }

    function repaintModules() {
        svg
            .selectAll(".module")
            .data(nodes.modules)
            .transition()
            .duration(1000)
            .attr("cx", function(d) { return d.x })
            .attr("cy", function(d) { return d.y })
        svg
            .selectAll(".modulename")
            .data(nodes.modules)
            .transition()
            .duration(1000)
            .attr("x", function(d) { return d.x + CIRCLE_R + 10})
            .attr("y", function(d) { return d.y +10});
    }

    function positionGroups() {
        switch (state) {
            case ALL_GROUPS_DIAGRAM:
                for (i = 0; i < nodes.groups.length; i++) {
                    var angle = (360 / totalGroups) * i;
                    var x = offset + radius * Math.cos(angle * Math.PI / 180);
                    var y = offset + radius * Math.sin(angle * Math.PI / 180);
                    nodes.groups[i].x = x;
                    nodes.groups[i].y = y;
                    nodes.groups[i].width = GROUPS_SMALL_WIDTH;
                    nodes.groups[i].height = GROUPS_SMALL_HEIGHT;
                }
                break;
            case SELECTED_GROUPS_DIAGRAM:
                var groupDepsTo = []
                var groupDepsFrom = []
                for (i = 0; i < nodes.depGroupGroups.length; i++) {
                    var depGroupGroup = nodes.depGroupGroups[i];
                    if (depGroupGroup.from == selectedGroup){
                        if (groupDepsTo.indexOf(depGroupGroup.to)==-1) {
                            groupDepsTo.push(depGroupGroup.to);
                        }
                    }
                }
                for (i = 0; i < nodes.depGroupGroups.length; i++) {
                    var depGroupGroup = nodes.depGroupGroups[i];
                    if (depGroupGroup.to == selectedGroup){
                        if ((groupDepsFrom.indexOf(depGroupGroup.to)==-1) && groupDepsTo.indexOf(depGroupGroup.to)==-1) {
                            groupDepsFrom.push(depGroupGroup.from);
                        }
                    }
                }
                var depFromIndex = 0;
                var depToIndex = 0;

                for (i = 0; i < nodes.groups.length; i++) {
                    var groupName = nodes.groups[i].name;
                    if (groupDepsFrom.indexOf(groupName)!=-1){
                        nodes.groups[i].x = 50+depFromIndex*50;
                        nodes.groups[i].y = 100 - (depFromIndex%3)*20;
                        nodes.groups[i].width = GROUPS_SMALL_WIDTH;
                        nodes.groups[i].height = GROUPS_SMALL_HEIGHT;
                        depFromIndex++;
                    }
                    else if (groupDepsTo.indexOf(groupName)!=-1){
                        nodes.groups[i].x = 50+depToIndex*50;
                        nodes.groups[i].y = 300 + (depToIndex%3)*20;
                        nodes.groups[i].width = GROUPS_SMALL_WIDTH;
                        nodes.groups[i].height = GROUPS_SMALL_HEIGHT;
                        depToIndex++;
                    }
                    else if (groupName == selectedGroup){
                        nodes.groups[i].x = 200;
                        nodes.groups[i].y = 200;
                        nodes.groups[i].width = GROUPS_SMALL_WIDTH;
                        nodes.groups[i].height = GROUPS_SMALL_HEIGHT;
                    }
                    else{
                        nodes.groups[i].width = 0;
                        nodes.groups[i].height = 0;
                        nodes.groups[i].x = 0;
                        nodes.groups[i].y = -20;
                    }
                }
                break;
            case GROUP_MODULES_DIAGRAM:
                for (i = 0; i < nodes.groups.length; i++) {
                    var groupName = nodes.groups[i].name;
                    if (groupName == selectedGroup){
                        nodes.groups[i].x = 2;
                        nodes.groups[i].y = 2;
                        nodes.groups[i].width = width-4;
                        nodes.groups[i].height = height-4;
                    }
                    else{
                        nodes.groups[i].width = 0;
                        nodes.groups[i].height = 0;
                        nodes.groups[i].x = 0;
                        nodes.groups[i].y = -20;
                    }
                }
                break;
            default:
                for (i = 0; i < nodes.groups.length; i++) {
                    nodes.groups[i].x = CIRCLE_R*-1;
                    nodes.groups[i].y = CIRCLE_R*-1;
                }
                break;
        }
    }


    function positionModules() {
        var groupModules = [];
        for (i = 0; i < nodes.modules.length; i++) {
            var module = nodes.modules[i];
            if (module.group == selectedGroup) {
                groupModules.push(module);
            }
        }

        var totalModules = groupModules.length;

        // first reset all positions
        for (i = 0; i < nodes.modules.length; i++) {
            nodes.modules[i].x = CIRCLE_R*-1;
            nodes.modules[i].y = CIRCLE_R*-1;
        }

        // set only the selected modules
        switch (state) {
            case ALL_GROUPS_DIAGRAM:
                break;
            case SELECTED_GROUPS_DIAGRAM:
                break;
            case GROUP_MODULES_DIAGRAM:
                for (i = 0; i < groupModules.length; i++) {
                    var angle = (360 / totalModules) * i;
                    var x = offset + radius * Math.cos(angle * Math.PI / 180);
                    var y = offset + radius * Math.sin(angle * Math.PI / 180);
                    groupModules[i].x = x;
                    groupModules[i].y = y;
                }
                break;
            default:
                break;
        }
    }


</script>